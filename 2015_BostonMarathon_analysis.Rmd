---
title: "2015 Boston Marathon Results Analysis"
author: "Joshua Gardner -  jpgard.com"
date: "April 5, 2016"
output: html_document
---

#Background and Motivation

The Boston Marathon is one of the world's oldest and most prestigious marathons. Begun in 1897, the Boston Marathon is the world's oldest annual marathon and ranks as one of the world's best-known racing events. It is one of six World Marathon Majors, and is one of four major events held in the United States through the years of both World Wars (Kentucky Derby, Rose Parade, and Westminster Kennel Club Dog Show are the others). The Boston Marathon attracts olympians and world record-holders each year, and as many as 50,000 amateur and professional runners gather to join an elite and competitive field of runners. The Boston Marathon is particularly unique in that registration is not open to all participants--runners must qualify by running a specified marathon time for their age group and gender--making the race especially prestigious and a career-long goal for many runners. Held on Patriot's Day each year, the race attracts well over 500,000 spectators along its historic and famous 26.2 mile course from Hopkinton into downtown Boston.

This project was motivated by several factors. Despite how famous and historic the race and its course are, very little is publicly shared about how participants actually perform in the marathon. The Boston Marathon makes searchable results available on their website, but reports very little about how runners actually perform on the course. Given that this is one of the world's most prestigious marathons, and given the unique population of runners that participate in this race, it seemed like an especially interesting and useful dataset to obtain and explore. Additionally, having participated in the boston marathon five times as a runner myself, I was particularly interested in learning more about the race's results. 

The four specific questions I intended to explore for this dataset originally were:

* Who are the runners of the Boston Marathon? Where do most runners come from, what are their ages, what genders are they?
*How fast are the runners of the Boston Marathon? What are the average finishing times for men and women, and within five-year age groups (i.e., 25-30 years old)? How do these finishing times compare to the qualifying times needed to gain entry into the race?
* How do runners run the race? Do they typically start fast, and slow down as the race progresses and they become fatigued, or do the more experienced runners that qualify for Boston pace themselves and achieve an even performance? How does this vary across age groups and genders?
* Who doesn’t finish the race? Each year, a small number of runners (approximately 1,000) do not finish the race, which results in a result typically referred to as ‘DNF’ (Did Not Finish). What types of runners comprise this group, in terms of age, gender, and nationality?

The final question, however, is not answerable with the dataset I obtained: the BAA (Boston Athletic Association, the race's organizing body) does not publish results for racers who do not post a finishing time. So, I replaced the final question with:

* How do elite athletes perform in the race?

#Data Source

The data obtained in this project are not publicly available, as a whole, which was a main source of motivation for this project--searchable Boston Marathon results are available at BAA.org, but the results are limited to a maximum of 25 pages of results, and there are no visualizations or aggregate statistics available for either demographic or performance-related aspects of the race participants. The data were obtained by creating a web scraping program in Python that was developed with a friend (the version of this scraper used to extract the data for this project is attached; the most recent version of the scraper is maintained at https://github.com/jpgard). The program systematically searches for groups of runners by country and state, extracts the page html into a database, and then parses the html using BeautifulSoup to create a csv file of the data fields scraped from the site.

The original data includes the following fields:

bib_number: The athlete's number. It is important to note that bib numbers are actually more than just nominal vairables and contain important data: bib bumbers are assigned in ascending order based on athletes' qualifying times (every athlete is required to submit a verifiable qualifying time from a previous marathon that meets or exceeds a specific standard for the athlete's gender and age group). These can be thought of as pre-race rankings.  
name, age, gender, city, state, country, origin: These are all various demographic variables for the runners. Of particular interest here are age (which is used to generate age groupings), gender, and country (the runner's country of citizenship).
5k, 10k, 15k, 20k, half, 25k, 30k, 35k, 40k, official_time: The times in which the runner completed various distance segments of the course. These are used to explore particularly interesting metrics related to runner performance.
pace: The runner's average pace, in minutes per mile, across the 26.2 mile race (this is obtained by dividing the runner's official time by 26.2).
projected_time: This variable is nulled for every runner. It appears that this is populated **during** the race for spectators, and is a projection based on runners' current pace on race day, but that the projected time is removed once runners finish the race.	
overall.place, gender.place, division.place: The runner's place, based on finishing time, overall, in their gender, and in their age division.

In all, this dataset contained 22,328 observations of 26 variables, after removing rows without data. This dataset should represent all runners who received official finish times for the 2015 Boston Marathon, but excludes runners who did not start or finish the race, dropped out, missed any checkpoint along the way, or had their results excluded from the online database.

#Methods

(a) how did you manipulate the data to prepare it for analysis?  

Extensive manipulation was performed on the data even in order to obtain it, and a great deal of further manipulation was required to prepare it for analysis and visualization. As mentioned above, the data was obtained from the BAA.org searchable results page using a web scraper, attached to this submission and also poasted at https://github.com/jpgard. This scraper systematically submitted searches by using http 'post' requests identical to those generated from an in-browser search. The scraper then stored the raw html in a database for later extraction, so that html could be stored and manipulated without repeatedly querying the results page. This html was parsed, using BeautifulSoup, and a csv with all of the available data fields from the search results was output by the scraper. 

The csv file from the web scraper was then imported into R, and, in the steps shown in the code below, several manipulations were performed. The primary manipulations were:

=**Generating age groups**: Boston Marathon participants span a wide range of ages, and there is a great deal of variation in performance across age groups. For most metrics, comparisons across age groups introduced excessive noise into comparisons and were not meaningful. Additionally, many race statistics are typically reported by age group. For these reasons, I manually generated age groups for runners that matched the age groups used by the BAA for qualifying times (information on those groups is available at http://www.baa.org/Races/Boston-Marathon/Participant-Information/Qualifying.aspx). Age groups were generated using the **cut()** function in R.

-**Converting times to dateTime and duration objects:** Dealing with times is difficult, but dealing with the times as strings would be nearly impossible. I experimented with several different packages and data types for handling the times, but eventually settled on converting the times to *duration* objects using the **as.duration()** function. I elected not to use POSIX objects because these inherently introduce a date into the object (the POSIX class is typically used for times of day and dates), and the race times being used here did not contain any date elements. Using the *duration* class seemed more semantically accurate than simply encoding the times as numeric values, for instance, and also provided other useful fonctionality, like the ability to easily change between units of time (seconds, minutes, hours).

-**Generating times for 5k race segments:**


(b) How did you handle missing, incomplete, or noisy data?



(c) How did you perform data analysis in code, i.e. Briefly describe the workflow of your source code
(d) What challenges did you encounter and how did you solve them?

#Data Preprocessing

```{r}
library(plyr)
library(lubridate)
library(ggplot2)
library(tidyr)
results = read.csv("resultsfinal.csv", stringsAsFactors=FALSE)

#create divisions for age groups, based on agr goups listed at http://raceday.baa.org/statistics.html
results$age_group = cut(results$age, breaks = c(0, 35, 40, 45, 50, 55, 60, 65, 70, 75, 80), labels = c("18-34", "35-39", "40-44", "45-49", "50-54", "60-64", "65-69", "70-74", "75-79", "80+"), right = FALSE, ordered_result = TRUE)

#import qualifying times and add to data
qualTimes = read.table("qualifyingTimes.txt", sep = '\t', colClasses = c("factor", "factor", "character"))
names(qualTimes) = c("age_group", "gender", "qualifying_time")

#convert gender, county_origin to factor variables
results$gender = factor(results$gender); results$gender = factor(results$gender); results$county = factor(results$county)

results = merge(results, qualTimes)

#convert times to duration objects using as.difftime() and lubridate's as.duration()

results$X5k <- as.duration(as.difftime(tim = results$X5k, format = "%T", units = "secs"))
results$X10k <- as.duration(as.difftime(tim = results$X10k, format = "%T", units = "secs"))
results$X15k <- as.duration(as.difftime(tim = results$X15k, format = "%T", units = "secs"))
results$X20k <- as.duration(as.difftime(tim = results$X20k, format = "%T", units = "secs"))
results$half <- as.duration(as.difftime(tim = results$half, format = "%T", units = "secs"))
results$X25k <- as.duration(as.difftime(tim = results$X25k, format = "%T", units = "secs"))
results$X30k <- as.duration(as.difftime(tim = results$X30k, format = "%T", units = "secs"))
results$X35k <- as.duration(as.difftime(tim = results$X35k, format = "%T", units = "secs"))
results$X40k <- as.duration(as.difftime(tim = results$X40k, format = "%T", units = "secs"))
results$pace <- as.duration(as.difftime(tim = results$pace, format = "%T", units = "secs"))
results$official_time <- as.duration(as.difftime(tim = results$official_time, format = "%T", units = "secs"))
results$qualifying_time <- as.duration(as.difftime(tim = results$qualifying_time, format = "%T", units = "secs"))

results = na.omit(results)
```

#Analysis: Four Guiding Questions

##1. Who are the runners of the Boston Marathon? 
####Where do most runners come from, what are their ages, what genders are they?

```{r}
countrycounts = data.frame(table(results$county))
names(countrycounts) <- c("Country", "Entrants")
ggplot(countrycounts, aes(x = reorder(Country, -Entrants), y = Entrants)) + geom_bar(stat="identity") + xlab("Country") + ggtitle("Entrants By Country") + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))

#TODO: print top 10 sorted

#TODO: print countries with <5 entries just for fun?

#TODO: filled country map
```

Individually visualized, the age distributions of female (top) and male (bottom) runners are shown below:
```{r}
ggplot(results, aes(x=age)) + geom_histogram(fill = "dodgerblue", colour="black", alpha = 0.3) + facet_grid(gender ~ .)
```

We can also directly compare the age distributions of male and female runners by overlaying them:
```{r}
ggplot(results, aes(x=age, fill = gender)) + geom_density(alpha = 0.3)
```
As seen above, females have a relatively higher proportion of runners younger than approximately 45 years of age, and males have a relatively higher proportion of runners older than 45 (although, in general, the distributions are wuite similar).

##2. How fast are the runners of the Boston Marathon? 
####What are the average finishing times for men and women, and within age groups? How do these finishing times compare to the qualifying times needed to gain entry into the race?

```{r}

ggplot(results, aes(x=age_group, y=official_time)) + geom_violin(fill = "dodgerblue", alpha = 0.3) + ggtitle("Official Finishing Times By Age Group")
ggplot(results, aes(x=age_group, y=official_time)) + geom_boxplot(fill = "dodgerblue", alpha = 0.3) + ggtitle("Official Finishing Times By Age Group")

ggplot(results, aes(x=gender, y=official_time)) + geom_violin(fill = "dodgerblue", alpha = 0.3) + ggtitle("Official Finishing Times By Age Group")
ggplot(results, aes(x=gender, y=official_time)) + geom_boxplot(fill = "dodgerblue", alpha = 0.3) + ggtitle("Official Finishing Times By Age Group")

#faceted plots with qualifying times for men, women
ggplot(subset(results, gender == "M"), aes(x=gender, y=official_time)) + geom_violin(fill = "dodgerblue", alpha = 0.5) + ggtitle("Official Finishing Times By Age Group (Men)\n Relative to Qualifying Standard")  + geom_hline(aes(yintercept=qualifying_time), size=1, colour = "gold") + facet_grid(. ~ age_group) + theme(axis.text.x = element_blank(), axis.title.x=element_blank(), axis.title.y=element_blank()) + scale_y_continuous(breaks=c(3600, 7200, 10800, 14400, 18000, 21600), labels=c("1:00:00","2:00:00", "3:00:00", "4:00:00", "5:00:00", "6:00:00"))


ggplot(subset(results, gender == "F"), aes(x=gender, y=official_time)) + geom_violin(fill = "dodgerblue", alpha = 0.5) + ggtitle("Official Finishing Times By Age Group (Women)\n Relative to Qualifying Standard")  + geom_hline(aes(yintercept=qualifying_time), size=1, colour = "gold") + facet_grid(. ~ age_group) + theme(axis.text.x = element_blank(), axis.title.x=element_blank(), axis.title.y=element_blank()) + scale_y_continuous(breaks=c(3600, 7200, 10800, 14400, 18000, 21600), labels=c("1:00:00","2:00:00", "3:00:00", "4:00:00", "5:00:00", "6:00:00"))


#TODO: split violin plots for male/female, within each age group --  see http://stackoverflow.com/questions/35717353/split-violin-plot-with-ggplot2
```


##3. How do runners run the race? 
####Do they typically start fast, and slow down as the race progresses and they become fatigued, or do the more experienced runners that qualify for Boston pace themselves and achieve an even performance? How does this vary across age groups and genders?

```{r}
#create variable for second half
results$sec_half = results$official_time - results$half


half_times <- results[,c("bib_number", "gender", "age_group", "half", "sec_half")] %>%
  gather(half, time, half:sec_half)
 
half_times$half = factor(ifelse(half_times$half == "half", 1, 2))
half_times$time = as.numeric(half_times$time)

ggplot(half_times, aes(x = half, y = time)) + geom_violin(fill = "dodgerblue", alpha = 0.5)

#Main plot--TODO: adjust color
ggplot(half_times, aes(x = half, y = time)) + geom_violin(aes(fill = half, colour = half), alpha = 0.5) + facet_grid(gender ~ age_group) + stat_summary(fun.y=median, geom="point", fill="white", shape=21, size=2.5)

ggplot(half_times, aes(x = half, y = time)) + geom_jitter(aes(colour = gender, alpha = 0.5))


#plot difference between first 5k and last 5k
ggplot(results, aes(x=age_group, y=results$X40k - results$X35k-results$X5k)) + geom_violin(fill = "dodgerblue", alpha = 0.3) + stat_summary(fun.y=median, geom="point", fill="gold", shape=21, size=2.5)

ggplot(results, aes(x=age_group, y=results$X40k - results$X35k-results$X5k)) + geom_jitter(colour = "dodgerblue", alpha = 0.3) + scale_y_continuous(limits = c(-1800, 1800), breaks = c(-1800, -1200, -600, 0, 600, 1200, 1800), labels = c("-30:00", "-20:00", "-10:00", "00:00", "+10:00", "+20:00", "+30:00")) + ylab("Difference in minutes") + ggtitle("Difference between first and final 5k times\nby age group")
```

```{r}
#Data processing for pace calculation along various 5k segments
library(dplyr)
segment_5k_times <- results %>%
    mutate(segment_5k = X5k, segment_10k = X10k - X5k, segment_15k = X15k-X10k, segment_20k = X20k-X15k, segment_25k = X25k-X20k, segment_30k = X30k-X25k, segment_35k=X35k-X30k, segment_40k = X40k-X35k) %>%
    gather(km_segment, time, segment_5k:segment_40k) %>%
    mutate(km_segment = as.factor(as.numeric(gsub("k", "", gsub("segment_", "", km_segment))))) %>%
    subset(select = -c(name, age, bib_number, city, origin, X5k:sec_half))

ggplot(filter(segment_5k_times, age_group <= "45-49"), aes(x = km_segment, y = time)) + geom_jitter(colour = "dodgerblue", alpha = 0.3)+ geom_boxplot(fill = "white", width = 0.2, outlier.shape = NA) + facet_grid(age_group ~ gender) + xlab("5k segment") + ylab("Segment Time") + scale_y_continuous(limits = c(900, 2700), breaks = c(1200,  1800,  2400), labels = c("20:00", "30:00", "40:00")) + ggtitle("Performance over 5k race segments by gender and age group\n2015 Boston Marathon")

ggplot(filter(segment_5k_times, age_group > "45-49"), aes(x = km_segment, y = time)) + geom_jitter(colour = "dodgerblue", alpha = 0.3)+ geom_boxplot(fill = "white", width = 0.2, outlier.shape = NA) + facet_grid(age_group ~ gender) + xlab("5k segment") + ylab("Segment Time") + scale_y_continuous(limits = c(900, 2700), breaks = c(1200,  1800,  2400), labels = c("20:00", "30:00", "40:00")) + ggtitle("Performance over 5k race segments by gender and age group\n2015 Boston Marathon")
    
```

##4. Who doesn’t finish the race? 
####Each year, a small number of runners (approximately 1,000) do not finish the race, which results in a result typically referred to as ‘DNF’ (Did Not Finish). What types of runners comprise this group, in terms of age, gender, and nationality?

#Appendix: Extra Plots and Exploratory Analysis

#### How is pace related to age group?
```{r}
ggplot(results[results$age_group!="NA",], aes(x=age_group, y=pace)) + geom_violin()
```

####How is bib number (= rank based on qualifying time) related to overall performance? Do runners with faster qualifying times place higher?
```{r}
#note: these are interesting graphs but need a little more wrangling to come out right!
plot(as.numeric(results$bib_number), as.numeric(results$overall_place), col = "dodgerblue", main = "Bib Number vs. Finish Place")
abline(0, 1, col = "gold", lwd = 4)

#ggplot(results, aes(x = bib_number, y = overall_place)) + geom_point()
#ggplot(results, aes(x = bib_number, y = overall_place)) + stat_binhex()
```